{% extends "base.html" %}


{% block content %}

<script>

	function submitQuery(type, params) {
		console.log('submitting '+ type + ' ' +params['pretty'])
		query_start = (new Date).getTime();
		$("#query_took").html("crunching big numbers for you...")

		var opts = {
			lines: 17, // The number of lines to draw
			length: 0, // The length of each line
			width: 10, // The line thickness
			radius: 31, // The radius of the inner circle
			corners: 1, // Corner roundness (0..1)
			rotate: 0, // The rotation offset
			direction: 1, // 1: clockwise, -1: counterclockwise
			color: '#000', // #rgb or #rrggbb or array of colors
			speed: 1, // Rounds per second
			trail: 100, // Afterglow percentage
			shadow: false, // Whether to render a shadow
			hwaccel: true, // Whether to use hardware acceleration
			className: 'spinner', // The CSS class to assign to the spinner
			zIndex: 2e9, // The z-index (defaults to 2000000000)
			top: 'auto', // Top position relative to parent in px
			left: 'auto' // Left position relative to parent in px
		};

		
		var target = document.getElementById('results_spinner');
		var spinner = new Spinner(opts).spin(target);
		
		var jqxhr = $.get(
		base_url+'location/?bearer_token=' + used_token, params, 
		function(data) { gotData(data, params); }).fail(function() {if (jqxhr.status == 401) { alert('Your token has expired or is not valid, we will try to refresh the window'); location.reload(); } else {alert('Something went wrong...'); $('#results_spinner').html('')}});

	}

	function updateURL() {
		params_string = ''
		var params = buildParams();
		for (key in params) {
			params_string += key+'='+params[key]+'&'
		}

		url = base_url + 'location/?bearer_token='+used_token + '&' + params_string
		$('#div_url').html('<small><a href="'+url+'">'+url+'</a></small>')
		
	}


	function selectText(containerid) {
		if (document.selection) {
			var range = document.body.createTextRange();
			range.moveToElementText(document.getElementById(containerid));
			range.select();
			} else if (window.getSelection) {
			var range = document.createRange();
			range.selectNode(document.getElementById(containerid));
			window.getSelection().addRange(range);
		}
	}


	function gotData(data, params) {

		if (params['pretty'] == false)
		{
			if (validate('visualization[]')=='-1')
				{
					data = JSON.stringify(data)
					$('#results').html(data); 
					$('#results_spinner').html(''); 
				}
			else if (validate('visualization[]')=='1')
				{
					var map;
					var marker;
					var mapOptions = {
					    zoom: 11,
					    center: new google.maps.LatLng(55.763516,12.494943),
					    mapTypeId: google.maps.MapTypeId.ROADMAP
					  };
					$('#map-canvas').css('display', 'block'); 
					$('#results').css('display', 'none'); 
					  map = new google.maps.Map(document.getElementById('map-canvas'),
					      mapOptions);

					content=data["results"]
					for (var i=0; i<content.length; i++)
					{
						longitude=content[i]['data']['LOCATION']['geojson']['coordinates'][1];
						latitude=content[i]['data']['LOCATION']['geojson']['coordinates'][0];
						point_new = new google.maps.LatLng(latitude,longitude);
						marker = new google.maps.Marker({
						    map:map,
						    draggable:false,
						    position: point_new
						  });
					}	
				}
		}
		else
			{
				$('#map-canvas').css('display', 'none'); 
				$('#results').css('display', 'block'); 
				$('#results').html(data); 
			}

	
		$('#results_spinner').html(''); 
		query_end = (new Date).getTime();
		$("#query_took").html("took "+(query_end-query_start)+" ms")

	}

	function validate(name){
		var chks = document.getElementsByName(name);
		for (var i = 0; i < chks.length; i++)
		{
			if (chks[i].checked)
			{
				return chks[i].value
				break;
			}
		}
	}

	function buildParams() {
		console.log(document.getElementById('param_pretty').checked)
		
		params = {}
		
		if (validate('visualization[]')=='-1' ) //Text visualization
			{params['pretty'] = document.getElementById('param_pretty').checked}
		else if (validate('visualization[]')=='1' ) //Map visualization
			{params['pretty'] = false}

		params['decrypted'] = document.getElementById('decrypted').checked

		if (document.getElementById('fields').value !='')
			{params['fields'] = document.getElementById('fields').value}

		if (document.getElementById('sortby').value !='')
			{params['sortby'] = document.getElementById('sortby').value}

		params['order'] = validate('order[]')
		
		if (document.getElementById('start_date').value !='')
			{params['start_date'] = document.getElementById('start_date').value}
			
		if (document.getElementById('end_date').value !='')
			{params['end_date'] = document.getElementById('end_date').value}

		if (document.getElementById('limit').value !='')
			{params['limit'] = parseInt(document.getElementById('limit').value)}
		
	if (document.getElementById('not_for_user_users').value !='')
			{params['users'] = document.getElementById('not_for_user_users').value}
		
		return params;
	}

</script>

<style type="text/css">
	.scrollable {
		height: 100%;
		overflow: auto;
	}
</style>


<div class="page-header">
	<h3>Location</h3>
	<div style="word-wrap: break-word;" id="div_url"></div>
</div>

<div class="row">
<form id="params_form" onchange="updateURL();" onclick="updateURL();">
		<p>
		<div class="span5">
			<p class="lead"><input type="checkbox" id="param_pretty" value="Pretty" checked> Pretty formatting</input></p>
		</div>

		<div class="span5" id="not_for_researcher_decrypted"> 
			<p class="lead"><input type="checkbox" id="decrypted" value="Decrypted"> Decrypted </input></p>
		</div>

	
<div class="span12">
	<label>Sort by</label>
		<p class="lead">
				<input type="text" id='sortby' placeholder="Field you want to sort by"/>
				<input type="radio" name="order[]" id="descending" value="-1"> Descending </input>
				<input type="radio" name="order[]" id="ascending" value="1" checked> Ascending </input>
		</p>
</div>
	

<div class="span12"> 
	<label>Fields to return</label>
		<div class="input-append">
				<div class="dropdown">
					<textarea rows="3" id='fields' placeholder="Enter the fields separeted with ','"></textarea>

					<button class="btn btn-primary" type="button" id="fields_picker" onclick="{ if ($('#example').css('display') == 'block') $('#example').css('display', 'none'); else  $('#example').css('display', 'block'); updateURL(); }"><i class="icon-align-left icon-white"></i></button>
					<button class="btn" type="button" id="fields_clear" onclick="{ $('#fields')[0].value = ''; updateURL();}"><i class="icon-remove"></i></button>


					<div id="example" class="dropdown-menu" role="menu" aria-labelledby="dLabel" style="position: relative">
						<pre style="word-wrap: break-word; white-space: pre-wrap; font-family:monospace; display: block; margin: 1em 0px">
<small>
{{ example_doc | safe }}
</small>
						</pre>
					</div>


			</div>
	</div>
</div> 


	

<div class="span5"> 
	<label>Start Date</label>
	<div class="input-append">
		<input class="span" type="number" id="start_date" value="" placeholder="epoch timestamp"></input>
		<button class="btn btn-primary" type="button" id="start_date_picker"><i class="icon-calendar icon-white"></i></button>
	</div>

	<script type="text/javascript">
		$('#start_date_picker').datepicker()
			.on('changeDate', function(e){
			var y = e.date.getTime()/1000
			$('#start_date')[0].value=y;
			updateURL();
		});
	</script>
</div>
	

<div class="span5"> 
	<label>End Date</label>
	<div class="input-append">
		<input class="span" type="number" id="end_date" value="" placeholder="epoch timestamp"></input>
		<button class="btn btn-primary" type="button" id="end_date_picker"><i class="icon-calendar icon-white"></i></button>
	</div>

	<script type="text/javascript">
		$('#end_date_picker').datepicker()
			.on('changeDate', function(e){
			var y = e.date.getTime()/1000
			$('#end_date')[0].value=y;
			updateURL();
		});
	</script>
</div>

<div class="span5"> 
	<label>No. of documents (max. 1000)</label>
	<input type="number" id='limit' max=1000 min=0 value=1000 placeholder="No. of documents"></input>
</div>

<div class="span5" id="not_for_user_users_div"> 
	<label>Users</label>
			<textarea rows="3" id='not_for_user_users' placeholder="Comma separated list of users"></textarea>
</div> 


	
<div class="span6">
	<label>Visualization</label>
		<p class="lead">
				<input type="radio" name="visualization[]" id="text" value="-1" checked> Text </input>
				<input type="radio" name="visualization[]" id="map" value="1" > Map </input>
		</p>

</div>

</p>
</form>
</div>

<div class="row">
		<p><hr></p>	
		<div class="span6"> 
			<button class="btn btn-primary" type="button" onclick="submitQuery('location', buildParams());">Submit <i class="icon-chevron-right icon-white"></i></button>
			<button class="btn" type="button" onclick="selectText('results')"><i class="icon-pencil"></i> Select</button>
			<button class="btn" type="button" onclick="$('#results').html(''); $('#map-canvas').html('')"><i class="icon-remove"></i> Clear</button>
			<p><div id="query_took"></div></p>
		</div>
</div>

	<div id="results_spinner"></div>
{% endblock %}

{% block results %}

<p></hr></p>

<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?v=3.14&sensor=false"></script>
<div id='results' class="pre-scrollable" style="height: auto; max-height: 600px">
</div>

<div class= "span google-maps" id="map-canvas" style="height: 600px; display: none;">
</div>

<script>
	updateURL()
</script>

{% endblock %}
